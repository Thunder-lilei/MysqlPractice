<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>答题</title>
		<link rel="stylesheet" href="../css/bootstrap.min.css" type="text/css" />
		<link rel="stylesheet" href="../css/bootstrap-grid.min.css" type="text/css" />
		<link rel="stylesheet" href="../css/bootstrap-reboot.min.css" type="text/css" />
		<script src="../js/jquery.min.js"></script>
		<script src="../js/answer.js"></script>
	</head>
	<body>

		<nav class="navbar navbar-expand-sm bg-dark navbar-dark" style="margin-bottom:30px">
			<a class="navbar-brand" href="#">SQL在线测试</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="collapsibleNavbar">
				<ul class="navbar-nav">
					<li class="nav-item">
						<a class="nav-link" href="#">首页</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">功能</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">功能</a>
					</li>
				</ul>
			</div>
		</nav>
		<div class="container-fluid">

			<div class="row">
				<div class="col-6">
					<div class="card">
						<div class="card-header bg-info text-white">
							题目
						</div>
						<div id="question" class="card-body">

						</div>
					</div>
					<br>
					<div class="card">
						<div class="card-header bg-info text-white">
							解答
						</div>
						<div class="card-body">
							<!--<form class="form-horizontal">-->
							<div class="control-group">

								<div class="controls">
									<textarea style="width: 100%; height: 400px ;overflow: auto;word-break: break-all; resize: none;" id="inputsql"></textarea>
								</div>
							</div>

							<div class="control-group">
								<div class="controls">
									<button type="button" class="btn btn-primary" id="btnformat" onclick="sql_format()">格式化</button>
									<button type="button" onclick="preview()" class="btn btn-primary">运行</button>
									<button type="button" onclick="compare()" class="btn btn-success">提交</button>
								</div>
							</div>
							<!--</form>-->
						</div>
					</div>
				</div>
				<div class="col-6">
					<div class="card">
						<div class="card-header bg-primary text-white">
							预览
						</div>
						<div class="card-body">
							<table class="table">
								<tbody id="tbody">
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
			<br>
			<div class="row">
				<div class="col-12 text-center">
					<input type="button" class="btn btn-circle" value="上一题" />
					<input type="button" class="btn btn-circle" value="回目录" onclick="javascript:window.location.href='./quizs.html'" />
					<input type="button" class="btn btn-circle" value="下一题" />
				</div>
			</div>
		</div>
		<script type="text/javascript" src="../js/bootstrap.js"></script>
		<script type="text/javascript" src="../js/bootstrap.bundle.js"></script>
		<script type="text/javascript" src="../js/sql-formatter.min.js"></script>
		<script>
			function sql_format() {
				let btn = document.getElementById('btnformat')
				let input = document.getElementById('inputsql');
				let output = document.getElementById('inputsql');
				input.addEventListener('btn', format);

				function format() {
					console.time('formatting');
					output.value = sqlFormatter.format(input.value, "SQL");
					console.timeEnd('formatting');
				}
				format();
			}

			function preview() {
				$.getJSON('/Mysql_practice/sql/preview', {
					sql: $("#inputsql").val()
				}, function(data) {
					let message = '';
					let previewlist = '';
					$.each(data, function(index, item) {
						if (index == "message") {
							message = item
						}
						if (index == "previewlist") {
							previewlist = JSON.stringify(item)
						}
					});
					switch (message) {
						case "success":
							break;
						default:
							alert(message);
					}
					let tbody = document.getElementById("tbody")
					let tbodychildren = tbody.childNodes;
					for (var i = tbodychildren.length - 1; i >= 0; i--) {
						tbody.removeChild(tbodychildren.item(i));
					}
					$.each($.parseJSON(previewlist), function(index, item) {
						let previewdata = item;
						let newtr = document.createElement("tr");
						$.each(previewdata, function(index, item) {
							let newtd = document.createElement("td");
							newtd.innerHTML = item;
							newtr.appendChild(newtd);
						});
						tbody.appendChild(newtr);
					});

				});
			}

			function compare() {
				let id = GetQueryString("id");
				$.getJSON('/Mysql_practice/sql/compare_sql', {
					sqlstring: $("#inputsql").val(),
					id: id
				}, function(data) {
					let message = '';
					let result = '';
					$.each(data, function(index, item) {
						if (index == "message") {
							message = item
						}
						if (index == "result") {
							result = JSON.stringify(item)
						}
					});
					switch (message) {
						case "success":
							break;
						default:
							alert(message);
					}
					alert(result);
					if (result == "\"Different\"") {
						setCookie(id, 2, 30);
					}else if(result == "\"Same\"") {
						setCookie(id, 1, 30);
					}
					
				});
					
			}

			function GetQueryString(name) {
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r != null) return decodeURI(r[2]);
				return null;
			}

			function setCookie(cname, cvalue, exdays) {
				var d = new Date();
				d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
				var expires = "expires=" + d.toGMTString();
				document.cookie = cname + "=" + cvalue + "; " + expires;
			}

			function getCookie(cname) {
				var name = cname + "=";
				var ca = document.cookie.split(';');
				for (var i = 0; i < ca.length; i++) {
					var c = ca[i].trim();
					if (c.indexOf(name) == 0) {
						return c.substring(name.length, c.length);
					}
				}
				return "";
			}
		</script>
	</body>
</html>
